[
    {
        "cve_id": "CVE-2021-31855",
        "func_name": "KDE/messagelib/ViewerPrivate::deleteAttachment",
        "description": "KDE Messagelib through 5.17.0 reveals cleartext of encrypted messages in some situations. Deleting an attachment of a decrypted encrypted message stored on a remote server (e.g., an IMAP server) causes KMail to upload the decrypted content of the message to the remote server. With a crafted message, a user could be tricked into decrypting an encrypted message and then deleting an attachment attached to this message. If the attacker has access to the messages stored on the email server, then the attacker could read the decrypted content of the encrypted message. This occurs in ViewerPrivate::deleteAttachment in messageviewer/src/viewer/viewer_p.cpp.",
        "git_url": "https://github.com/KDE/messagelib/commit/3b5b171e91ce78b966c98b1292a1bcbc8d984799",
        "commit_title": "Fix CVE-2021-31855",
        "commit_text": " Deleting an attachment of a decrypted encrypted message stored on a remote server (e.g. an IMAP server) causes KMail to upload the decrypted content of the message to the remote server. This is not easily noticeable by the user because KMail does not display the decrypted content.",
        "func_before": "bool ViewerPrivate::deleteAttachment(KMime::Content *node, bool showWarning)\n{\n    if (!node) {\n        return true;\n    }\n    KMime::Content *parent = node->parent();\n    if (!parent) {\n        return true;\n    }\n\n    const QVector<KMime::Content *> extraNodes = mNodeHelper->extraContents(mMessage.data());\n    if (extraNodes.contains(node->topLevel())) {\n        KMessageBox::error(mMainWindow,\n                           i18n(\"Deleting an attachment from an encrypted or old-style mailman message is not supported.\"),\n                           i18n(\"Delete Attachment\"));\n        return true; // cancelled\n    }\n\n    if (showWarning\n        && KMessageBox::warningContinueCancel(mMainWindow,\n                                              i18n(\"Deleting an attachment might invalidate any digital signature on this message.\"),\n                                              i18n(\"Delete Attachment\"),\n                                              KStandardGuiItem::del(),\n                                              KStandardGuiItem::cancel(),\n                                              QStringLiteral(\"DeleteAttachmentSignatureWarning\"))\n            != KMessageBox::Continue) {\n        return false; // cancelled\n    }\n    // don't confuse the model\n    mMimePartTree->clearModel();\n    QString filename;\n    QString name;\n    QByteArray mimetype;\n    if (auto cd = node->contentDisposition(false)) {\n        filename = cd->filename();\n    }\n\n    if (auto ct = node->contentType(false)) {\n        name = ct->name();\n        mimetype = ct->mimeType();\n    }\n\n    // text/plain part:\n    auto deletePart = new KMime::Content(parent);\n    auto deleteCt = deletePart->contentType(true);\n    deleteCt->setMimeType(\"text/x-moz-deleted\");\n    deleteCt->setName(QStringLiteral(\"Deleted: %1\").arg(name), \"utf8\");\n    deletePart->contentDisposition(true)->setDisposition(KMime::Headers::CDattachment);\n    deletePart->contentDisposition(false)->setFilename(QStringLiteral(\"Deleted: %1\").arg(name));\n\n    deleteCt->setCharset(\"utf-8\");\n    deletePart->contentTransferEncoding()->setEncoding(KMime::Headers::CE7Bit);\n    QByteArray bodyMessage = QByteArrayLiteral(\"\\nYou deleted an attachment from this message. The original MIME headers for the attachment were:\");\n    bodyMessage += (\"\\nContent-Type: \") + mimetype;\n    bodyMessage += (\"\\nname=\\\"\") + name.toUtf8() + \"\\\"\";\n    bodyMessage += (\"\\nfilename=\\\"\") + filename.toUtf8() + \"\\\"\";\n    deletePart->setBody(bodyMessage);\n    parent->replaceContent(node, deletePart);\n\n    parent->assemble();\n\n    KMime::Message *modifiedMessage = mNodeHelper->messageWithExtraContent(mMessage.data());\n    mMimePartTree->mimePartModel()->setRoot(modifiedMessage);\n    mMessageItem.setPayloadFromData(modifiedMessage->encodedContent());\n    auto job = new Akonadi::ItemModifyJob(mMessageItem, mSession);\n    job->disableRevisionCheck();\n    connect(job, &KJob::result, this, &ViewerPrivate::itemModifiedResult);\n    return true;\n}",
        "func": "bool ViewerPrivate::deleteAttachment(KMime::Content *node, bool showWarning)\n{\n    if (!node) {\n        return true;\n    }\n    KMime::Content *parent = node->parent();\n    if (!parent) {\n        return true;\n    }\n\n    const QVector<KMime::Content *> extraNodes = mNodeHelper->extraContents(mMessage.data());\n    if (extraNodes.contains(node->topLevel())) {\n        KMessageBox::error(mMainWindow,\n                           i18n(\"Deleting an attachment from an encrypted or old-style mailman message is not supported.\"),\n                           i18n(\"Delete Attachment\"));\n        return true; // cancelled\n    }\n\n    if (showWarning\n        && KMessageBox::warningContinueCancel(mMainWindow,\n                                              i18n(\"Deleting an attachment might invalidate any digital signature on this message.\"),\n                                              i18n(\"Delete Attachment\"),\n                                              KStandardGuiItem::del(),\n                                              KStandardGuiItem::cancel(),\n                                              QStringLiteral(\"DeleteAttachmentSignatureWarning\"))\n            != KMessageBox::Continue) {\n        return false; // cancelled\n    }\n    // don't confuse the model\n    mMimePartTree->clearModel();\n    QString filename;\n    QString name;\n    QByteArray mimetype;\n    if (auto cd = node->contentDisposition(false)) {\n        filename = cd->filename();\n    }\n\n    if (auto ct = node->contentType(false)) {\n        name = ct->name();\n        mimetype = ct->mimeType();\n    }\n\n    // text/plain part:\n    auto deletePart = new KMime::Content(parent);\n    auto deleteCt = deletePart->contentType(true);\n    deleteCt->setMimeType(\"text/x-moz-deleted\");\n    deleteCt->setName(QStringLiteral(\"Deleted: %1\").arg(name), \"utf8\");\n    deletePart->contentDisposition(true)->setDisposition(KMime::Headers::CDattachment);\n    deletePart->contentDisposition(false)->setFilename(QStringLiteral(\"Deleted: %1\").arg(name));\n\n    deleteCt->setCharset(\"utf-8\");\n    deletePart->contentTransferEncoding()->setEncoding(KMime::Headers::CE7Bit);\n    QByteArray bodyMessage = QByteArrayLiteral(\"\\nYou deleted an attachment from this message. The original MIME headers for the attachment were:\");\n    bodyMessage += (\"\\nContent-Type: \") + mimetype;\n    bodyMessage += (\"\\nname=\\\"\") + name.toUtf8() + \"\\\"\";\n    bodyMessage += (\"\\nfilename=\\\"\") + filename.toUtf8() + \"\\\"\";\n    deletePart->setBody(bodyMessage);\n    parent->replaceContent(node, deletePart);\n\n    parent->assemble();\n\n    KMime::Message *modifiedMessage = mNodeHelper->messageWithExtraContent(mMessage.data());\n    mMimePartTree->mimePartModel()->setRoot(modifiedMessage);\n    mMessageItem.setPayloadFromData(mMessage->encodedContent());\n    auto job = new Akonadi::ItemModifyJob(mMessageItem, mSession);\n    job->disableRevisionCheck();\n    connect(job, &KJob::result, this, &ViewerPrivate::itemModifiedResult);\n    return true;\n}",
        "diff_func": "--- func_before\n+++ func_after\n@@ -61,7 +61,7 @@\n \n     KMime::Message *modifiedMessage = mNodeHelper->messageWithExtraContent(mMessage.data());\n     mMimePartTree->mimePartModel()->setRoot(modifiedMessage);\n-    mMessageItem.setPayloadFromData(modifiedMessage->encodedContent());\n+    mMessageItem.setPayloadFromData(mMessage->encodedContent());\n     auto job = new Akonadi::ItemModifyJob(mMessageItem, mSession);\n     job->disableRevisionCheck();\n     connect(job, &KJob::result, this, &ViewerPrivate::itemModifiedResult);",
        "diff_line_info": {
            "deleted_lines": [
                "    mMessageItem.setPayloadFromData(modifiedMessage->encodedContent());"
            ],
            "added_lines": [
                "    mMessageItem.setPayloadFromData(mMessage->encodedContent());"
            ]
        }
    }
]